<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sakura.poetry.mapper.UserCommentMapper">

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, user_id, poetry_id, parent_id, reply_user_id, content, like_count, reply_count,
        status, created_time, updated_time
    </sql>

    <!-- 根据诗词ID查询评论列表 -->
    <select id="selectByPoetryId" parameterType="long" resultType="com.sakura.poetry.entity.UserComment">
        SELECT <include refid="Base_Column_List"/>
        FROM user_comment
        WHERE poetry_id = #{poetryId} AND status = 1
        ORDER BY created_time DESC
    </select>

    <!-- 查询顶级评论列表（分页） -->
    <select id="selectTopLevelComments" resultType="com.sakura.poetry.entity.UserComment">
        SELECT <include refid="Base_Column_List"/>
        FROM user_comment
        WHERE poetry_id = #{poetryId} AND parent_id IS NULL AND status = 1
        ORDER BY created_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据父评论ID查询回复列表 -->
    <select id="selectRepliesByParentId" parameterType="long" resultType="com.sakura.poetry.entity.UserComment">
        SELECT <include refid="Base_Column_List"/>
        FROM user_comment
        WHERE parent_id = #{parentId} AND status = 1
        ORDER BY created_time ASC
    </select>

    <!-- 增加评论的点赞数 -->
    <update id="incrementLikeCount">
        UPDATE user_comment
        SET like_count = like_count + #{count}
        WHERE id = #{commentId}
    </update>

    <!-- 增加评论的回复数 -->
    <update id="incrementReplyCount">
        UPDATE user_comment
        SET reply_count = reply_count + #{count}
        WHERE id = #{commentId}
    </update>

</mapper>