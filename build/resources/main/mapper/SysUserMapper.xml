<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sakura.poetry.mapper.SysUserMapper">

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, username, nickname, email, phone, password, avatar, gender, birthday, signature,
        status, last_login_time, last_login_ip, created_by, created_time, updated_by, updated_time, is_deleted
    </sql>

    <!-- 根据用户名查询用户信息 -->
    <select id="selectByUsername" parameterType="string" resultType="com.sakura.poetry.entity.SysUser">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE username = #{username} AND is_deleted = 0
    </select>

    <!-- 根据邮箱查询用户信息 -->
    <select id="selectByEmail" parameterType="string" resultType="com.sakura.poetry.entity.SysUser">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <!-- 根据手机号查询用户信息 -->
    <select id="selectByPhone" parameterType="string" resultType="com.sakura.poetry.entity.SysUser">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE phone = #{phone} AND is_deleted = 0
    </select>

    <!-- 查询用户列表（分页） -->
    <select id="selectUserList" parameterType="com.sakura.poetry.entity.SysUser" resultType="com.sakura.poetry.entity.SysUser">
        SELECT <include refid="Base_Column_List"/>
        FROM sys_user
        WHERE is_deleted = 0
        <if test="username != null and username != ''">
            AND username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="nickname != null and nickname != ''">
            AND nickname LIKE CONCAT('%', #{nickname}, '%')
        </if>
        <if test="email != null and email != ''">
            AND email LIKE CONCAT('%', #{email}, '%')
        </if>
        <if test="phone != null and phone != ''">
            AND phone LIKE CONCAT('%', #{phone}, '%')
        </if>
        <if test="status != null">
            AND status = #{status.value}
        </if>
        ORDER BY created_time DESC
    </select>

    <!-- 更新用户最后登录信息 -->
    <update id="updateLastLoginInfo">
        UPDATE sys_user
        SET last_login_time = NOW(), last_login_ip = #{lastLoginIp}
        WHERE id = #{userId}
    </update>

    <!-- 逻辑删除 -->
    <update id="logicDeleteById" parameterType="long">
        UPDATE sys_user
        SET is_deleted = 1
        WHERE id = #{id}
    </update>

</mapper>